<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>OpenMag</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Source+Sans+Pro:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
    <script src="https://unpkg.com/imagesloaded@5/imagesloaded.pkgd.min.js"></script>
    
<style>
    * { box-sizing: border-box; } /* Essential for grid math */
    body { background-color: #fdfaf6; font-family: 'Source Sans Pro', sans-serif; margin: 0; padding: 40px 20px; }
    h1 { font-family: 'Playfair Display', serif; text-align: center; font-size: 3.5rem; margin-bottom: 5px; color: #1a1a1a; }
    .subline { text-align: center; text-transform: uppercase; letter-spacing: 3px; font-size: 0.8rem; margin-bottom: 50px; color: #888; }
    
    .grid { width: 100%; max-width: 1400px; margin: 0 auto; }
    
    /* Force column widths */
    .grid-sizer, .grid-item { width: 31%; } /* Fixed percentage for stability */

    @media (max-width: 1000px) { .grid-sizer, .grid-item { width: 48%; } }
    @media (max-width: 600px) { .grid-sizer, .grid-item { width: 100%; } }

    .grid-item {
        margin-bottom: 25px;
        background: #fff;
        border-radius: 4px;
        overflow: hidden;
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        text-decoration: none;
        color: inherit;
        display: block;
    }

    .grid-item img { width: 100%; height: auto; display: block; min-height: 50px; background: #eee; }
    .grid-item.no-image { border-top: 5px solid #b58d67; }

    .content { padding: 25px; }
    .category { text-transform: uppercase; font-size: 0.65rem; letter-spacing: 2px; color: #b58d67; font-weight: 600; margin-bottom: 12px; display: block; }
    h2 { font-family: 'Playfair Display', serif; margin: 0 0 15px; font-size: 1.4rem; line-height: 1.2; color: #1a1a1a; }
    p { color: #555; line-height: 1.7; font-size: 0.95rem; margin-bottom: 0; }

    /* Base button style */
.filter-btn {
    transition: all 0.3s ease; /* Smooth transition when clicking */
    padding: 8px 16px;
    margin: 5px;
    border: 1px solid #ddd;
    border-radius: 20px;
    background: white;
    cursor: pointer;
}

/* Hover state */
.filter-btn:hover {
    border-color: #b58d67;
    color: #b58d67;
}

/* THE INDICATOR STATE (Active) */
.filter-btn.active {
    background: #b58d67 !important; /* Your theme brown */
    color: white !important;
    border-color: #b58d67 !important;
    box-shadow: 0 4px 12px rgba(181, 141, 103, 0.4);
    font-weight: bold;
    transform: scale(1.05); /* Slight pop out effect */
}
</style>
</head>
<body>

    <h1>OpenMag</h1>
    <div class="subline">Hyvi√§ uutisia</div>
    <div id="filters" style="text-align: center; margin-bottom: 30px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;"></div>
    <div class="grid" id="magazine-grid">
        <div class="grid-sizer"></div>
    </div>

   <script>
const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRUveH7tPtcCI0gLuCL7krtgpLPPo_nasbZqxioFhftwSrAykn3jOoJVwPzsJnnl5XzcO8HhP7jpk2_/pub?gid=0&single=true&output=csv';

let allArticles = []; 
let displayedCount = 0;
const PAGE_SIZE = 15;
let currentFilter = 'All';
let msnry;

async function buildMagazine() {
    const container = document.querySelector('#magazine-grid');
    
    // 1. Initialize Masonry immediately so the grid exists
    msnry = new Masonry(container, {
        itemSelector: '.grid-item',
        columnWidth: '.grid-sizer',
        percentPosition: true,
        gutter: 25
    });

    window.refreshGrid = () => msnry.layout();

    try {
        // 2. Fetch the JSON created by the Robot
        const response = await fetch('data.json');
        allArticles = await response.json(); // Remove 'const' here to use global variable
        
        // 3. Setup Filters
        const categories = [...new Set(allArticles.map(a => a.sheetCategory))];
        createFilterUI(categories);

        // 4. Initial Display
        displayArticles();
    } catch (e) {
        console.error("Magazine load failed. data.json might be missing or empty.", e);
    }
}

function displayArticles() {
    const container = document.querySelector('#magazine-grid');
    const filtered = allArticles.filter(a => currentFilter === 'All' || a.sheetCategory === currentFilter);
    const slice = filtered.slice(displayedCount, displayedCount + PAGE_SIZE);

    if (slice.length === 0) return;

    slice.forEach(item => {
        // Use Robot's found image first, then fallback
        const img = item.enforcedImage || extractImg(item);
        const imageHtml = img ? `<img src="https://wsrv.nl/?url=${encodeURIComponent(img)}&w=800&af" referrerpolicy="no-referrer" onload="refreshGrid()" onerror="this.parentElement.classList.add('no-image'); this.remove(); refreshGrid();">` : "";
        
        const rawSnippet = item.description || item.content || "";
        const cleanSnippet = rawSnippet.replace(/<[^>]*>/g, '').trim().substring(0, 200);
        
        const cardHtml = `
            <a href="${item.link}" target="_blank" class="grid-item">
                ${imageHtml}
                <div class="content">
                    <span class="category">${item.sheetCategory || 'News'}</span>
                    <h2>${item.title}</h2>
                    <p>${cleanSnippet}...</p>
                    <small style="color:#aaa; display:block; margin-top:10px;">${item.sourceTitle || ''}</small>
                </div>
            </a>`;
        
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = cardHtml;
        const el = tempDiv.firstElementChild;
        
        container.appendChild(el);
        msnry.appended(el);
    });

    displayedCount += PAGE_SIZE;
    imagesLoaded(container).on('always', () => msnry.layout());
}

// ... Keep your existing setFilter, createFilterUI, and extractImg functions exactly as they are ...

buildMagazine();
</script>
</body>
</html>
