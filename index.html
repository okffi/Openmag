<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>OpenMag</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
    <script src="https://unpkg.com/imagesloaded@5/imagesloaded.pkgd.min.js"></script>
    
    <style>
        :root {
            --primary-color: #007AFF;
            --bg-color: #ffffff;
            --sidebar-bg: #f8f9fa;
            --text-dark: #121212;
            --text-muted: #6c757d;
            --card-bg: #ffffff;
            --border-color: #eeeeee;
            --sidebar-width: 280px;
        }

        * { box-sizing: border-box; }
        a { text-decoration: none !important; color: inherit; }
        
        body { 
            background-color: var(--bg-color); 
            font-family: 'DM Sans', sans-serif; 
            margin: 0; 
            padding: 0;
            color: var(--text-dark);
            line-height: 1.6;
            display: flex;
            min-height: 100vh;
        }

        /* SIVUPALKKI */
        .sidebar { 
            height: 100vh; 
            width: var(--sidebar-width); 
            position: sticky;
            top: 0; 
            left: 0; 
            background-color: var(--sidebar-bg); 
            border-right: 1px solid var(--border-color);
            transition: transform 0.4s ease, margin-left 0.4s ease;
            flex-shrink: 0;
            overflow-y: auto;
            z-index: 2000;
        }

        .sidebar.closed {
            margin-left: calc(-1 * var(--sidebar-width));
        }

        .sidebar h3 { 
            padding: 30px 30px 20px; 
            margin: 0; 
            font-family: 'Playfair Display', serif; 
            font-size: 1.5rem; 
            color: var(--text-dark);
        }

        #sidebar-toggle { 
            position: fixed; top: 15px; left: 20px; z-index: 1500; 
            background: var(--text-dark); 
            color: white; border: none; padding: 10px 18px; 
            border-radius: 0; 
            cursor: pointer; 
            font-size: 0.7rem; font-weight: 700;
        }

        .sidebar-view-toggle {
            display: flex;
            padding: 0 20px 15px;
            gap: 10px;
        }
        
        .sidebar-view-toggle button {
            flex: 1;
            background: none;
            border: 1px solid var(--border-color);
            padding: 8px 5px;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            cursor: pointer;
            color: var(--text-muted);
            transition: all 0.2s;
        }
        
        .sidebar-view-toggle button.active {
            background: var(--text-dark);
            color: white;
            border-color: var(--text-dark);
        }
        
        /* SIVUPALKKI - HAITARI JA KOHTEET */
        .category-group {
            border-bottom: 1px solid var(--border-color);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.65rem;
            color: var(--text-dark);
            letter-spacing: 2px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .category-header:hover {
            background-color: #fff;
            color: var(--primary-color);
        }

        .category-header::after {
            content: '+';
            font-family: 'DM Sans', sans-serif;
            font-size: 1rem;
            font-weight: 400;
            color: #ccc;
            transition: transform 0.3s ease;
        }

        .category-group.open .category-header::after {
            content: '−';
            color: var(--primary-color);
        }

        .source-submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0, 1, 0, 1);
            background-color: #ffffff;
        }

        .category-group.open .source-submenu {
            max-height: 2000px;
            transition: max-height 0.4s ease-in;
        }

        .source-item { 
            cursor: pointer; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-size: 0.85rem; 
            color: var(--text-muted); 
            padding: 10px 20px;
            transition: all 0.2s ease;
        }

        .source-submenu .source-item {
            padding-left: 35px;
            font-size: 0.8rem;
        }
        
        .source-item:hover { 
            background-color: #fff; 
            color: var(--primary-color); 
        }
        
        .source-item.active { 
            background-color: #fff; 
            color: var(--primary-color); 
            font-weight: 700; 
            border-left: 3px solid var(--primary-color); 
        }
        
        .source-item span { font-size: 0.7rem; color: #b7b7b7; font-weight: 400; }
        
        /* A-Ö badge tyyli */
        .count-badge { font-size: 0.7rem; color: #b7b7b7; }

        /* SISÄLTÖALUE JA HEADER */
        main {
            flex-grow: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
        }

        header { 
            position: sticky; 
            top: 0; 
            z-index: 1000; 
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: center;
        }

        header h1 { 
            font-family: 'Playfair Display', serif;
            font-size: 1.1rem; 
            margin: 0;
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        .header-controls {
            display: flex;
            gap: 10px;
            padding: 15px;
            background: #f8f9fa;
            border-bottom: 1px solid #ddd;
            flex-wrap: wrap; /* Wraps nicely on mobile */
        }
        
        .news-select {
            padding: 8px 12px;
            border-radius: 20px;
            border: 1px solid #ccc;
            font-size: 14px;
            outline: none;
            cursor: pointer;
            background: white;
        }
        
        .news-select:hover {
            border-color: #007bff;
        }

        #feed-header-area {
            display: flex;
            align-items: center;
            gap: 25px;
            margin: 40px 20px;
            min-height: 80px;
        }
        
        #feed-info-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            flex-grow: 1;
        }
            
        #feed-logo-container {
            flex-shrink: 0;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #feed-logo-container img {
            max-width: 80px;
            max-height: 80px;
            width: auto;
            height: auto;
            display: block;
            transition: transform 0.3s ease;
        }
        
        #feed-logo-container.dark-bg { 
            background-color: #1a1a1a; 
        }
        
        #feed-logo-container.dark-bg img {
            max-width: 60px;
            max-height: 60px;
        }
        
        .view-title {
            font-family: 'Playfair Display', serif;
            font-size: 2.4rem;
            color: var(--text-dark);
            margin: 0;
            line-height: 1.1;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        #current-view-description {
            font-size: 0.95rem;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .title-link:hover { color: var(--primary-color); }

        .rss-link {
            display: inline-flex; /* Tämä on kriittinen */
            align-items: center;
            justify-content: center;
            vertical-align: middle; /* Auttaa tekstin seassa */
            color: var(--primary-color);
            opacity: 0.4;
            transition: opacity 0.2s;
        }
        
        .rss-link svg {
            width: 20px;
            height: 20px;
            display: block; /* Poistaa SVG:n oletusarvoisen pienen tyhjän tilan alla */
        }
        .rss-link:hover { opacity: 1; }

        /* GRID & CARDS */
        .grid { width: 100%; max-width: 1400px; margin: 0 auto; padding: 0 20px; opacity: 0; transition: opacity 0.5s ease; }
        .grid.loaded { opacity: 1; }
        .grid-sizer, .grid-item { width: 31%; }

        .grid-item {
            margin-bottom: 25px; 
            background: var(--card-bg); 
            border: 1px solid var(--border-color);
            display: block; 
            transition: border-color 0.3s ease;
        }
        .grid-item:hover { border-color: var(--primary-color); }
        
        .grid-item img { width: 100%; height: auto; display: block; background: #f8f9fa; }

        .content { padding: 20px; }
        .content .category-label { 
            text-transform: uppercase; 
            font-size: 0.6rem; 
            letter-spacing: 2px; 
            color: var(--primary-color) !important; 
            font-weight: 700; 
            display: block; 
            margin-bottom: 10px; 
        }
        
        .grid-item h2 { 
            font-family: 'Playfair Display', serif; 
            margin: 0 0 12px; 
            font-size: 1.35rem; 
            line-height: 1.25; 
            color: var(--text-dark); 
        }
        
        .grid-item p { 
            color: var(--text-muted); 
            font-size: 0.9rem; 
            line-height: 1.5;
            margin-bottom: 0; 
        }
        
        .meta-info { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-top: 15px; 
            padding-top: 15px; 
            border-top: 1px solid #f8f9fa;
            font-size: 0.6rem; 
            letter-spacing: 1px;
            color: #999;
            text-transform: uppercase;
        }

        #scroll-sentinel { text-align: center; padding: 80px 0; font-size: 0.8rem; color: #bbb; text-transform: uppercase; letter-spacing: 3px; }

        @media (max-width: 1100px) { .grid-sizer, .grid-item { width: 48%; } }
        @media (max-width: 650px) { 
            .grid-sizer, .grid-item { width: 100%; } 
            .sidebar { position: fixed; transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .sidebar.closed { margin-left: 0; }
        }
    </style>
</head>
<body>

    <button id="sidebar-toggle" onclick="toggleSidebar()">☰</button>

    <aside id="source-sidebar" class="sidebar">
        <h3>Julkaisijat</h3>
        <div class="sidebar-view-toggle">
            <button id="btn-categories" class="active" onclick="showSidebarView('categories')">Kategoriat</button>
            <button id="btn-az" onclick="showSidebarView('az')">A–Ö</button>
        </div>
        <div id="source-list"></div>
    </aside>

    <main>
        <header>
            <h1>OpenMag</h1>
        </header>
        <div id="feed-header-area">
            <div id="feed-logo-container"></div>
            <div id="feed-info-container">
                <div id="current-view-title" class="view-title">Tuoreimmat uutiset</div>
                <div id="current-view-description"></div>
            </div>
        </div>
        <div class="header-controls">
            <div class="filter-group">
                <select id="langFilter" class="news-select">
                    <option value="all">Languages (All)</option>
                    <option value="fi">Suomi</option>
                    <option value="en">English</option>
                    <option value="sv">Svenska</option>
                    <option value="de">Deutsch</option>
                    <option value="fr">Français</option>
                </select>
            </div>
        
            <div class="filter-group">
                <select id="scopeFilter" class="news-select">
                    <option value="all">Regions (All)</option>
                    <option value="Finland">Finland</option>
                    <option value="Nordic + Baltic countries">Nordic + Baltic</option>
                    <option value="Europe">Europe</option>
                    <option value="World">World</option>
                </select>
            </div>
        </div>
        <div class="grid" id="magazine-grid">
            <div class="grid-sizer"></div>
        </div>
        
        <div id="scroll-sentinel">Ladataan uutisia...</div>
    </main>

<script>
let allArticles = []; 
let displayedCount = 0;
const PAGE_SIZE = 50;
let msnry;
let isLoading = false;
let currentCategory = 'All';
let statsData = null; // Globaali välimuisti
let mainFeedCache = null;

// Globaali muuttuja käännöksille
let translations = {}; 

// Perusfunktio: hakee tekstin avaimen perusteella
function t(key) {
    const lang = document.getElementById('langFilter').value || 'en';
    if (translations[lang] && translations[lang][key]) {
        return translations[lang][key];
    }
    // Jos käännöstä ei löydy, palautetaan avain ilman ryhmä-etuliitettä (siistimpi fallback)
    return key.includes('.') ? key.split('.')[1].replace(/_/g, ' ') : key;
}

// Kohdan 1 funktio: muuttaa "Culture" -> "cat.culture" ja kääntää sen
function getTranslation(group, value) {
    if (!value) return t(`${group}.general`); // Fallback esim. cat.general
    
    // Luodaan tekninen avain (slug) samalla logiikalla kuin Sheetsissä
    const slug = value.toString()
        .replace(/[\(\)\+]/g, '') // Poistetaan ( ) +
        .trim()
        .replace(/\s+/g, '_')     // Välilyönnit -> alaviiva
        .replace(/[^a-zA-Z0-9_]/g, '') // Vain kirjaimet, numerot ja alaviiva
        .replace(/_+/g, '_')      // Ei tuplaviivoja
        .toLowerCase();
    
    const key = `${group}.${slug}`;
    return t(key);
}

    function resetFilters() {
        document.getElementById('langFilter').value = 'all';
        document.getElementById('scopeFilter').value = 'all';
        updateView();
    }
    
    function updateView() {
        displayedCount = 0;
        const container = document.querySelector('#magazine-grid');
        const existingItems = container.querySelectorAll('.grid-item');
        
        if (existingItems.length && msnry) {
            msnry.remove(existingItems);
            msnry.layout();
        }
    
        displayArticles();
        
        const activeView = document.getElementById('btn-az').classList.contains('active') ? 'az' : 'categories';
        showSidebarView(activeView);
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    // Add event listeners
    document.getElementById('langFilter').addEventListener('change', updateView);
    document.getElementById('scopeFilter').addEventListener('change', updateView);
    async function init() {
    const container = document.querySelector('#magazine-grid');
    msnry = new Masonry(container, { 
        itemSelector: '.grid-item', 
        columnWidth: '.grid-sizer', 
        percentPosition: true, 
        gutter: 25,
        transitionDuration: '0.4s'
    });

    // Make msnry available on window so inline image onload handlers can call it reliably
    window.msnry = msnry;

    await loadData('data.json', true);
    initSidebar(); // Tämä lataa myös statsData:n

    const observer = new IntersectionObserver((entries) => {
        if (entries[0].isIntersecting && !isLoading) displayArticles();
    }, { rootMargin: '400px' });
    observer.observe(document.querySelector('#scroll-sentinel'));
}

async function loadData(filePath, isInitial = false, forceRefresh = false) {
    isLoading = true;
    displayedCount = 0;
    const container = document.querySelector('#magazine-grid');
    const sentinel = document.querySelector('#scroll-sentinel');
    
     sentinel.innerText = "Ladataan uutisia...";
    container.classList.remove('loaded');
    
    const existingItems = container.querySelectorAll('.grid-item');
    if (existingItems.length) {
        msnry.remove(existingItems);
        msnry.layout();
    }

    try {
        // 1. PÄÄTETÄÄN HAETAANKO VERKOSTA VAI VÄLIMUISTISTA
        // Jos forceRefresh on true, haemme AINA uuden datan verkon yli
        if (filePath === 'data.json' && mainFeedCache && !isInitial && !forceRefresh) {
            allArticles = mainFeedCache;
            console.log("Käytetään muistissa olevaa syötettä.");
        } else {
            // Lisätään aikaleima JA no-cache -otsikot, jotta GitHub Pages / selain ei huijaa
            const response = await fetch(filePath + '?v=' + Date.now(), { 
                cache: 'no-cache', // no-cache tarkistaa onko tiedosto muuttunut
                headers: { 'Cache-Control': 'no-cache' }
            });

            if (!response.ok) throw new Error("Palvelin vastasi virheellä.");
            
            allArticles = await response.json();
            
            // Päivitetään muistiin vain jos ollaan päänäkymässä
            if (filePath === 'data.json') {
                mainFeedCache = allArticles;
            }
            console.log(`Haettu tuore data: ${filePath}`);
        }

        sentinel.innerText = "";
        displayArticles();
        
        // Päivitetään aikaleima UI:hin
        if (typeof updateViewMetadata === 'function') updateViewMetadata();

    } catch (e) { 
        console.error("Latausvirhe:", e); 
        sentinel.innerText = "Virhe ladattaessa uutisia.";
    } finally {
        isLoading = false; 
    }
}

/* --- Add this helper function near the other functions in the <script> --- */
function createArticleCard(item) {
  const img = item.enforcedImage;
  const card = document.createElement('div');
  card.className = `grid-item ${!img ? 'no-image' : ''}`;

  const link = document.createElement('a');
  link.href = item.link || '#';
  link.target = '_blank';
  link.rel = 'noopener';

  if (img) {
    const image = document.createElement('img');
    image.src = `https://wsrv.nl/?url=${encodeURIComponent(img)}&w=800&af`;
    // use the global msnry reference; we make sure to set window.msnry in init()
    image.onload = () => { if (window.msnry && typeof window.msnry.layout === 'function') window.msnry.layout(); };
    link.appendChild(image);
  }

  const content = document.createElement('div');
  content.className = 'content';

  const category = document.createElement('span');
  category.className = 'category-label';
  category.textContent = item.sheetCategory || 'Yleinen';
  category.onclick = (e) => handleCategoryClick(e, item.sheetCategory || 'Yleinen');

  const h2 = document.createElement('h2');
  h2.textContent = item.title || '';

  const p = document.createElement('p');
  // strip HTML, limit length, and use textContent (safe)
  const clean = (item.content || "").replace(/<[^>]*>/g, '').substring(0, 150);
  p.textContent = clean + (clean.length ? '...' : '');

  const meta = document.createElement('div');
  meta.className = 'meta-info';

  const src = document.createElement('span');
  src.className = 'source-trigger';
  src.textContent = `${item.sourceTitle || 'Lähde'}${item.creator ? ' | ' + item.creator : ''}`;
  src.onclick = (e) => { e.stopPropagation(); handleSourceClick(e, item.sourceTitle); };

  const dateSpan = document.createElement('span');
  dateSpan.textContent = item.pubDate ? new Date(item.pubDate).toLocaleDateString('fi-FI') : '';

  meta.appendChild(src);
  meta.appendChild(dateSpan);

  content.appendChild(category);
  content.appendChild(h2);
  content.appendChild(p);
  content.appendChild(meta);

  link.appendChild(content);
  card.appendChild(link);

  return card;
}

/* Safe helper to set the title + RSS link without using innerHTML */
function setViewTitleAndRss(viewTitleEl, title, rssLink, isMainFeed, siteUrl) {
    if (!viewTitleEl) return;
    // remove previous children
    while (viewTitleEl.firstChild) viewTitleEl.removeChild(viewTitleEl.firstChild);

    if (isMainFeed) {
        viewTitleEl.appendChild(document.createTextNode(title));
    } else {
        const a = document.createElement('a');
        a.href = siteUrl || '#';
        a.target = '_blank';
        a.rel = 'noopener';
        a.className = 'title-link';
        a.textContent = title;
        viewTitleEl.appendChild(a);
    }

    const rssA = document.createElement('a');
    rssA.href = rssLink || '#';
    rssA.target = '_blank';
    rssA.rel = 'noopener';
    rssA.className = 'rss-link';
    rssA.title = 'RSS-lähde';
    // trusted static SVG for the icon
    rssA.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M6.18,15.64A2.18,2.18,0,0,1,8.36,17.82c0,1.21-.98,2.18-2.18,2.18A2.18,2.18,0,0,1,4,17.82,2.18,2.18,0,0,1,6.18,15.64M4,4.44A15.56,15.56,0,0,1,19.56,20h-2.83A12.73,12.73,0,0,0,4,7.27Zm0,5.66a9.9,9.9,0,0,1,9.9,9.9H11.07A7.07,7.07,0,0,0,4,12.93Z"/></svg>';
    viewTitleEl.appendChild(rssA);
}
    
function displayArticles() {
    const selectedLang = document.getElementById('langFilter').value;
    const selectedScope = document.getElementById('scopeFilter').value;

    // Suodatetaan globaali data ennen slice-operaatiota
    const filtered = allArticles.filter(art => {
        const langMatch = (selectedLang === 'all') || (art.lang === selectedLang);
        const scopeMatch = (selectedScope === 'all') || (art.scope === selectedScope);
        const catMatch = (currentCategory === 'All') || (art.sheetCategory === currentCategory);
        return langMatch && scopeMatch && catMatch;
    });

    const slice = filtered.slice(displayedCount, displayedCount + PAGE_SIZE);
    const sentinel = document.querySelector('#scroll-sentinel');

    if (slice.length === 0 && displayedCount === 0) {
        const isFiltered = document.getElementById('langFilter').value !== 'all' || 
                           document.getElementById('scopeFilter').value !== 'all';
        
        sentinel.innerHTML = isFiltered 
            ? `<div style="padding: 20px;">
                <p>Valituilla suodattimilla ei löytynyt uutisia.</p>
                <button onclick="resetFilters()" style="background:var(--text-dark); color:white; border:none; padding:8px 15px; cursor:pointer; font-size:0.7rem; font-weight:700; text-transform:uppercase;">Nollaa suodattimet</button>
               </div>`
            : "— Täällä ei ole juuri nyt uutta —";
            
        isLoading = false;
        return;
    }

    if (slice.length === 0) {
        sentinel.innerText = "— Olet ajan tasalla —";
        isLoading = false;
        return;
    }

    sentinel.innerText = "Ladataan lisää...";
    const container = document.querySelector('#magazine-grid');
    const newElements = [];

    slice.forEach(item => {
        const card = createArticleCard(item);
        container.appendChild(card);
        newElements.push(card);
    });

    // increment by actual number of appended items (fix for overshoot)
    displayedCount += slice.length;

    imagesLoaded(container, () => {
        if (msnry && typeof msnry.appended === 'function') {
            msnry.appended(newElements);
        }
        if (msnry && typeof msnry.layout === 'function') {
            msnry.layout();
        }
        container.classList.add('loaded');
        isLoading = false;
    });
}


// SIVUPALKKI-LOGIIKKA
async function initSidebar() {
    const list = document.getElementById('source-list');
    if (!list) return;

    if (!statsData) {
        try {
            // Lisätään cache: 'no-store' varmuuden vuoksi fetch-asetuksiin
            const response = await fetch('stats.json?v=' + Date.now(), { cache: 'no-store' });
            statsData = await response.json();
        } catch (e) { 
            console.error("Sidebar failed", e); 
            return;
        }
    }
    // Käytetään globaalia statsDataa (jonka fetch juuri täytti tai joka oli jo olemassa)
    renderCategoryView(list);
}

function renderCategoryView(list) {
    list.innerHTML = ''; 
    
    const selectedLang = document.getElementById('langFilter').value;
    const selectedScope = document.getElementById('scopeFilter').value;

    const mainItem = document.createElement('div');
    mainItem.className = 'source-item active';
    mainItem.textContent = 'Tuoreimmat uutiset';
    mainItem.onclick = (e) => changeSource('data.json', 'Tuoreimmat uutiset', e.currentTarget);
    list.appendChild(mainItem);

    const cats = {};
    Object.keys(statsData).forEach(name => {
        if (name === "__meta") return;
        
        const info = statsData[name];

        // --- UUSI SUODATUSLOGIIKKA ALKAA ---
        // Katsotaan suoraan stats.jsoniin tallennettuja tietoja
        const langMatch = (selectedLang === 'all') || (info.lang === selectedLang);
        const scopeMatch = (selectedScope === 'all') || (info.scope === selectedScope);

        if (!langMatch || !scopeMatch) return; // Hypätään yli, jos ei täsmää
        // --- UUSI SUODATUSLOGIIKKA PÄÄTTYY ---

        const cat = info.category || "Yleinen";
        if (!cats[cat]) cats[cat] = [];
        cats[cat].push({ name, ...info });
    });

    // Loppuosa on identtinen nykyisen koodisi kanssa
    Object.keys(cats).sort().forEach(catName => {
        const group = document.createElement('div');
        group.className = 'category-group';
        
        const header = document.createElement('div');
        header.className = 'category-header';
        header.textContent = catName;

        const submenu = document.createElement('div');
        submenu.className = 'source-submenu';

        header.onclick = () => {
            const wasOpen = group.classList.contains('open');
            document.querySelectorAll('.category-group').forEach(g => g.classList.remove('open'));
            if (!wasOpen) group.classList.add('open');
            filterByCategory(catName);
        };

        cats[catName].sort((a,b) => a.name.localeCompare(b.name, 'fi')).forEach(src => {
            const item = document.createElement('div');
            item.className = 'source-item';
            
            item.textContent = src.name + ' '; 
            const countSpan = document.createElement('span');
            countSpan.textContent = src.count;
            item.appendChild(countSpan);

            item.onclick = (e) => {
                e.stopPropagation();
                changeSource(`sources/${src.file}`, src.name, item);
            };
            submenu.appendChild(item);
        });

        group.appendChild(header);
        group.appendChild(submenu);
        list.appendChild(group);
    });
}

function renderAZView(list) {
    list.innerHTML = ''; 
    
    const selectedLang = document.getElementById('langFilter').value;
    const selectedScope = document.getElementById('scopeFilter').value;

    // "Tuoreimmat uutiset" -nappi
    const mainItem = document.createElement('div');
    mainItem.className = 'source-item';
    mainItem.textContent = 'Tuoreimmat uutiset';
    mainItem.onclick = (e) => changeSource('data.json', 'Tuoreimmat uutiset', e.currentTarget);
    list.appendChild(mainItem);

    // Suodatetaan ja lajitellaan lähteet suoraan statsDatan ominaisuuksien mukaan
    const sortedSources = Object.keys(statsData)
        .filter(key => {
            if (key === "__meta") return false;
            
            const info = statsData[key];
            const langMatch = (selectedLang === 'all') || (info.lang === selectedLang);
            const scopeMatch = (selectedScope === 'all') || (info.scope === selectedScope);
            
            return langMatch && scopeMatch;
        })
        .sort((a, b) => a.localeCompare(b, 'fi'));

    // Luodaan lähderivit
    sortedSources.forEach(sourceName => {
        const info = statsData[sourceName];
        const item = document.createElement('div');
        item.className = 'source-item';
        
        item.textContent = sourceName + ' ';
        
        const countSpan = document.createElement('span');
        countSpan.className = 'count-badge';
        countSpan.textContent = info.count;
        
        item.appendChild(countSpan);
        item.onclick = () => changeSource(`sources/${info.file}`, sourceName, item);
        
        list.appendChild(item);
    });
}

function showSidebarView(view) {
    const list = document.getElementById('source-list');
    const btnCat = document.getElementById('btn-categories');
    const btnAz = document.getElementById('btn-az');

    if (view === 'az') {
        btnAz.classList.add('active');
        btnCat.classList.remove('active');
        renderAZView(list);
    } else {
        btnCat.classList.add('active');
        btnAz.classList.remove('active');
        renderCategoryView(list);
    }
}

async function changeSource(file, title, el) {
    const viewTitle = document.getElementById('current-view-title');
    const viewDesc = document.getElementById('current-view-description');
    const logoCont = document.getElementById('feed-logo-container');

    // 1. Käyttäjäpalaute heti alussa
    if (viewTitle) viewTitle.textContent = title;
    if (viewDesc) viewDesc.innerText = "Ladataan...";

    // 2. Logon ja taustan nollaus
    if (logoCont) {
        logoCont.style.display = (file === 'data.json') ? 'none' : 'flex';
        logoCont.innerHTML = ""; 
        logoCont.classList.remove('dark-bg');
    }

    currentCategory = 'All';
    displayedCount = 0;

    // 3. Aktiivisen linkin korostus (Yhdenmukaistettu)
    document.querySelectorAll('.source-item').forEach(i => i.classList.remove('active'));
    
    if (el) {
        el.classList.add('active');
    } else {
        // Jos 'el' puuttuu (esim. sivun ensilataus), etsitään "Tuoreimmat uutiset" tekstin perusteella
        document.querySelectorAll('.source-item').forEach(i => {
            if (i.textContent.trim() === 'Tuoreimmat uutiset') i.classList.add('active');
        });
    }

    // 4. Datan lataus
    await loadData(file);

    // 5. Käyttöliittymän päivitys datan perusteella
    if (allArticles.length > 0) {
        const first = allArticles[0];
        const isMainFeed = (file === 'data.json');
        const rssLink = first.originalRssUrl || (isMainFeed ? 'data.json' : file);

        // Logo-logiikka (vain jos ei päänäkymä)
        if (!isMainFeed && logoCont) {
            // Nyt isDarkLogo toimii, kunhan se on JSON-datassa mukana
            if (first.isDarkLogo) logoCont.classList.add('dark-bg');

            if (first.sourceLogo) {
                const img = document.createElement('img');
                img.src = first.sourceLogo;
                img.alt = title;
                logoCont.appendChild(img);
            }
        }

        let siteUrl = "#";
        if (!isMainFeed) {
            try { siteUrl = new URL(first.link).origin; } catch(e) {}
        }

        // Käytetään olemassa olevaa apufunktiota otsikolle ja linkeille
        setViewTitleAndRss(viewTitle, title, rssLink, isMainFeed, siteUrl);

        if (viewDesc) {
            if (isMainFeed) {
                // Poimitaan päivitysaika statsDatasta
                const lastUpdate = (window.statsData && statsData.__meta) 
                    ? statsData.__meta.last_updated 
                    : "";
                
                viewDesc.innerText = `Kokoelma seurattujen lähteiden tuoreimpia uutisia. ${lastUpdate ? '(Päivitetty: ' + lastUpdate + ')' : ''}`;
            } else {
                // Näytetään lähteen oma kuvaus (esim. RSS-syötteestä poimittu)
                viewDesc.innerText = first.sourceDescription || "";
            }
        }
    }

    // 6. Sivupalkin sulkeminen mobiilissa
    if (window.innerWidth < 1000) {
        const sidebar = document.getElementById('source-sidebar');
        if (sidebar) sidebar.classList.remove('open');
    }
    
    // 7. Pehmeä skrollaus ylös
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function filterByCategory(catName) {
    currentCategory = catName;
    document.getElementById('current-view-title').innerText = catName;
    const viewDesc = document.getElementById('current-view-description');
    const logoCont = document.getElementById('feed-logo-container');
    
    if (viewDesc) viewDesc.innerText = `Uusimmat uutiset kategoriasta: ${catName}`;
    if (logoCont) {
        logoCont.innerHTML = ""; 
        logoCont.style.display = 'none';
    }

    displayedCount = 0;
    document.querySelectorAll('.source-item').forEach(i => i.classList.remove('active'));
    mainFeedCache = null;
    loadData('data.json');
}

function handleCategoryClick(event, catName) {
    event.preventDefault();
    event.stopPropagation();
    filterByCategory(catName);
}

async function handleSourceClick(event, sourceName) {
    event.preventDefault();
    event.stopPropagation();
    if (statsData && statsData[sourceName]) {
        changeSource(`sources/${statsData[sourceName].file}`, sourceName, null);
    }
}

function toggleSidebar() {
    const sidebar = document.getElementById('source-sidebar');
    if (window.innerWidth < 1000) {
        sidebar.classList.toggle('open');
    } else {
        sidebar.classList.toggle('closed');
        setTimeout(() => msnry.layout(), 450);
    }
}
    
window.addEventListener('DOMContentLoaded', () => {
    // Kutsutaan suoraan changeSource-funktiota oletusasetuksilla
    changeSource('data.json', 'Tuoreimmat uutiset');
});

init();
</script>
</body>
</html>
